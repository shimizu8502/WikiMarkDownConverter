# PukiWiki to Markdown Converter

GitHub
https://github.com/shimizu8502/WikiMarkDownConverter

DeepWiki
https://deepwiki.com/shimizu8502/WikiMarkDownConverter/1-wikimarkdownconverter-overview

## 概要

このアプリケーションは、PukiWiki形式で記述されたテキストファイルをMarkdown形式に変換する高機能なコンバーターです。
直感的なGUIインターフェースを提供し、PukiWikiデータが格納されたディレクトリと、変換後のMarkdownファイルを出力するディレクトリを簡単に指定できます。
特に、Obsidianでの利用を想定した内部リンク形式で出力し、全変換・更新変換・自動更新機能により効率的なワークフローを実現します。

## 🚀 主な新機能

### ⚙️ 変換モード選択
- **🔄 全変換**: 全ファイルを変換（既存mdファイル削除後）
- **📝 更新変換**: 更新されたファイルのみを変換

### 📊 タイムスタンプ管理
- **timestamps.md**: 前回変換時のファイルタイムスタンプを自動記録
- **差分検出**: 更新されたファイルのみを効率的に抽出
- **変換履歴**: いつ、どのファイルが変換されたかを追跡

### 🕒 自動更新機能（更新変換時のみ）
- **定期実行**: 指定した間隔（1-1440分）で自動的に更新変換を実行
- **バックグラウンド動作**: 作業を妨げずに自動でファイルを更新
- **手動停止**: いつでも自動更新を停止可能

### 💾 設定の自動保存・復元
- **リアルタイム保存**: 設定変更時に自動的に設定を保存
- **起動時復元**: 前回の設定状態を完全復元
- **エラー処理**: 設定保存・読み込み時の堅牢なエラー処理

## 🔧 基本機能

### PukiWiki構文の変換
- **見出し**: `*`, `**`, `***` → `#`, `##`, `###`
- **リスト**: 
  - `-`, `+` の変換と自動修正
  - `- 文字列`, `-- 文字列`, `---- 文字列` への正規化
  - **外部リンク対応**: 
    - `-http` → `- http`
    - `--http` → `- - http`
    - `---http` → `- -- http`
- **強調**: 
  - `'''文字列'''` → `**文字列**`
  - `''文字列''` → `*文字列*`
- **取り消し線**: `%%文字列%%` → `~~文字列~~` (Obsidian形式)
- **装飾記法**:
  - **フォントサイズ**: `&size(12){テキスト}` → `<span style="font-size: 12px;">テキスト</span>`
  - **色指定**: 
    - `&color(red){テキスト}` → `<span style="color: red;">テキスト</span>`
    - `&color(red,yellow){テキスト}` → `<span style="color: red; background-color: yellow;">テキスト</span>`
- **リンク**: 
  - `[[ページ名]]` → `[[ページ名]]` (Obsidian形式)
  - `[[エイリアス>ページ名]]` → `[[ページ名|エイリアス]]` (Obsidian形式)
- **画像**: `#ref(画像URL,altテキスト)` → `![altテキスト](画像URL)`
- **整形済みテキスト**: 行頭スペース → Markdownコードブロック
- **表組み**: 
  - パイプ区切り表 (`|A|B|C|`) 
  - カンマ区切り表 (`,A,B,C`)
  - ヘッダーマーカー (`|h`) 対応
  - 文字揃え指定変換 (`CENTER:`, `RIGHT:`, `LEFT:` および省略形対応)
- **コメント除去**: `//` の適切な処理（URL保護機能付き）

### ファイル処理機能
- **文字コード自動判別**: UTF-8, EUC-JP, Shift_JIS
- **手動文字コード指定**: 自動判別が困難な場合の手動選択
- **16進エンコードファイル名**: PukiWikiファイル名の自動デコード
- **ファイル連結**: 全Markdownファイルを日付付きで1ファイルに統合（自動更新時は除く）

### エラー処理・ログ機能
- **エラーログ**: `logs/conversion_errors.log` への詳細記録
- **タイムスタンプ付きログ**: エラー発生時刻を正確に記録
- **堅牢な例外処理**: エラー発生時も処理継続

## 📋 必要なもの

- **Python 3.x**
- **Tkinter** (通常Python標準ライブラリに含まれています)

## 🎯 使用方法

### 方法1: Windows環境でバッチファイルを使用する場合（推奨）

#### 🔧 初回セットアップ
1. `setup_environment.bat` をダブルクリックして実行
2. Python環境の確認、仮想環境の作成、必要なディレクトリの作成を自動実行
3. セットアップ完了メッセージを確認

#### 🚀 アプリケーションの起動
1. `run_converter.bat` をダブルクリックして実行
2. GUIウィンドウが表示され、変換作業が可能になります

### 方法2: コマンドラインから直接実行する場合

```bash
python pukiwiki_to_markdown.py
```

### 📁 基本設定

#### 1. ディレクトリの選択
- **PukiWikiデータディレクトリ**: PukiWiki形式のファイル (`.txt`, `.page`) が保存されているフォルダを選択
- **Markdown出力ディレクトリ**: 変換されたMarkdownファイル (`.md`) を保存するフォルダを選択
  - 存在しない場合は自動作成されます
  - **timestamps.md** ファイルも自動的にここに保存されます

#### 2. 文字コードの指定
- **auto (自動判別)**: デフォルト設定（推奨）
- **手動指定**: utf-8, euc-jp, shift_jis から選択可能

### ⚙️ 変換モードの選択

#### 🔄 全変換モード
- **用途**: 初回変換時、全ファイルを一括変換したい場合
- **動作**: 
  1. 既存の `.md` ファイルを削除（確認ダイアログ表示）
  2. 全PukiWikiファイルを変換
  3. **timestamps.md** ファイルを更新

#### 📝 更新変換モード
- **用途**: 定期的な更新、変更されたファイルのみ処理したい場合
- **動作**:
  1. **timestamps.md** から前回のタイムスタンプを読み込み
  2. 更新されたファイルのみを抽出
  3. 該当ファイルを変換（上書き保存）
  4. **timestamps.md** ファイルを更新

#### 🕒 自動更新機能（更新変換時のみ）
- **自動更新**: チェックボックスで有効/無効を切り替え
- **更新間隔**: 1〜1440分で設定可能
- **動作**: 設定した間隔で自動的に更新変換を実行
- **停止**: 「🛑 自動更新停止」ボタンで手動停止

### 🎮 実行

1. 「🚀 変換実行」ボタンをクリック
2. 進捗状況がリアルタイムで表示
3. 完了時に結果ダイアログが表示

## 📤 出力仕様

### ファイル出力
- **Markdownファイル**: 元のPukiWikiページ名と同名で `.md` 拡張子
- **フラット構造**: 出力ディレクトリ直下に配置
- **文字コード**: UTF-8でエンコード

### 特殊ファイル
- **timestamps.md**: タイムスタンプ管理ファイル（Markdown形式）
  - PukiWikiファイルのタイムスタンプをJSON形式で記録
  - 更新変換時の差分検出に使用
- **日付_obsidian.md**: 全Markdownファイルの連結ファイル
  - `logs/` ディレクトリ内に保存
  - ファイル区切り情報付きで全内容を統合
  - **注意**: 自動更新が有効な場合は作成されません

### リンク形式
- **Obsidian互換**: `[[ページ名]]` または `[[ページ名|エイリアス]]`
- **表組み**: テーブル前の改行挿入でObsidian表示最適化

## 🎨 装飾記法の変換仕様（NEW）

### フォントサイズ指定
**PukiWiki記法** → **Obsidian対応（HTML）**

```
&size(12){テキスト}        → <span style="font-size: 12px;">テキスト</span>
&size(1.5em){テキスト}     → <span style="font-size: 1.5em;">テキスト</span>
&size(150%){テキスト}      → <span style="font-size: 150%;">テキスト</span>
```

**特徴:**
- 数値のみの場合は自動的に`px`単位を付加
- `em`、`%`、`pt`等の単位が指定済みの場合はそのまま使用
- Obsidianで正しく表示されるHTML形式で出力

### 色指定
**PukiWiki記法** → **Obsidian対応（HTML）**

#### 文字色のみ指定:
```
&color(red){テキスト}      → <span style="color: red;">テキスト</span>
&color(#ff0000){テキスト}  → <span style="color: #ff0000;">テキスト</span>
&color(blue){重要なテキスト} → <span style="color: blue;">重要なテキスト</span>
```

#### 文字色と背景色を同時指定:
```
&color(red,yellow){テキスト}     → <span style="color: red; background-color: yellow;">テキスト</span>
&color(#000,#ffff00){テキスト}   → <span style="color: #000; background-color: #ffff00;">テキスト</span>
&color(white,navy){強調テキスト}  → <span style="color: white; background-color: navy;">強調テキスト</span>
```

#### 部分的な色指定:
```
&color(,yellow){テキスト}   → <span style="background-color: yellow;">テキスト</span>  (背景色のみ)
&color(red,){テキスト}      → <span style="color: red;">テキスト</span>              (文字色のみ)
```

**対応色形式:**
- **CSS色名**: red, blue, green, yellow, black, white, navy, etc.
- **16進数カラーコード**: #ff0000, #00ff00, #0000ff, #ffffff, etc.
- **RGB値**: rgb(255,0,0), rgba(255,0,0,0.5), etc.
- **その他CSS色指定**: hsl(), etc.

**変換ルール:**
- 空の色指定は無視（テキストのみ出力）
- 不正な色指定がある場合でも処理を継続
- カンマ区切りで文字色と背景色を分離

## ⚠️ 注意事項

### 対応状況
- **対応構文**: 一般的なPukiWikiの主要構文に対応
- **未対応**: 複雑な構文や独自拡張、一部プラグイン
- **文字コード判別**: 100%正確ではないため、必要に応じて手動指定推奨

### ファイル処理
- **16進ファイル名**: UTF-8デコードを自動実行
- **不正文字処理**: Windows不正ファイル名文字を安全な文字に置換
- **エラー処理**: 個別ファイルのエラーは処理全体を停止させない

### 自動更新機能
- **更新変換専用**: 全変換モードでは自動更新無効
- **バックグラウンド実行**: メッセージボックス表示を抑制
- **リソース管理**: アプリケーション終了時に自動停止

## 📁 設定ファイル

### converter_settings.ini
```ini
[Paths]
pukiwikidir = [PukiWikiディレクトリパス]
markdowndir = [Markdown出力ディレクトリパス]
encoding = [文字コード設定]
conversionmode = [full/update]
autoupdate = [True/False]
updateinterval = [更新間隔（分）]
```

### ログファイル
- **conversion_errors.log**: エラーログ（`logs/` ディレクトリ内）
- **タイムスタンプ付き**: エラー発生時刻を正確に記録

## 🗺️ 機能マインドマップ

```
PukiWiki to Markdown Converter v1.4
├── 🔄 変換モード
│   ├── 全変換
│   │   ├── 既存mdファイル削除
│   │   ├── 全ファイル変換
│   │   └── タイムスタンプ記録
│   └── 更新変換
│       ├── タイムスタンプ比較
│       ├── 差分ファイル抽出
│       ├── 選択的変換
│       └── タイムスタンプ更新
├── 🕒 自動更新機能
│   ├── 定期実行 (1-1440分)
│   ├── バックグラウンド動作
│   ├── 手動停止
│   └── 更新変換専用
├── 📊 タイムスタンプ管理
│   ├── timestamps.md生成
│   ├── JSON形式記録
│   ├── 差分検出
│   └── 変換履歴追跡
├── 💾 設定管理
│   ├── リアルタイム自動保存
│   ├── 起動時設定復元
│   ├── エラー処理
│   └── converter_settings.ini
├── 🔧 PukiWiki構文変換
│   ├── 見出し (*→#, **→##, ***→###)
│   ├── リスト変換・自動修正
│   │   ├── 基本リスト (-→-, +→*)
│   │   └── 外部リンク対応 (-http→- http, --http→- - http, ---http→- -- http)
│   ├── 強調・取り消し線
│   ├── 装飾記法 ⭐NEW⭐
│   │   ├── フォントサイズ (&size(12){テキスト}→<span style="font-size: 12px;">テキスト</span>)
│   │   └── 色指定 (&color(色,背景色){テキスト}→HTML span要素)
│   ├── リンク (Obsidian形式)
│   ├── 画像変換
│   ├── 整形済みテキスト → コードブロック
│   ├── 表組み
│   │   ├── パイプ区切り (|A|B|C|)
│   │   ├── カンマ区切り (,A,B,C)
│   │   ├── ヘッダーマーカー (|h)
│   │   └── 文字揃え (CENTER:, RIGHT:, LEFT:)
│   └── コメント除去 (URL保護)
├── 📁 ファイル処理
│   ├── 文字コード自動判別・手動指定
│   ├── 16進ファイル名デコード
│   ├── 不正文字処理
│   └── 連結ファイル生成（自動更新時は除く）
├── 🖥️ GUI
│   ├── ディレクトリ選択
│   ├── 変換モード選択
│   ├── 自動更新設定
│   ├── リアルタイム進捗表示
│   └── 直感的操作
├── 📝 ログ・エラー処理
│   ├── エラーログ記録
│   ├── タイムスタンプ付きログ
│   ├── 堅牢な例外処理
│   └── 詳細な状況報告
└── 🚀 実行環境
    ├── Windowsバッチファイル対応
    ├── 環境セットアップ自動化
    └── ワンクリック実行
```

## 🔮 今後の改善点 (TODO)

### 機能拡張
- [ ] より多くのPukiWiki構文・プラグインへの対応
- [ ] カスタム変換ルールの設定機能
- [ ] バッチ処理のスケジュール機能拡張

### UI/UX改善
- [ ] 変換プレビュー機能
- [ ] ドラッグ&ドロップ対応
- [ ] 変換結果の詳細統計表示

### パフォーマンス
- [ ] 大量ファイル処理の最適化
- [ ] 並列処理による高速化
- [ ] メモリ使用量の最適化

### 互換性
- [ ] macOS・Linux対応
- [ ] 他のWikiエンジン対応
- [ ] 複数のMarkdownエンジン対応

---

## 📞 サポート

問題が発生した場合は、`logs/conversion_errors.log` を確認し、エラーの詳細を把握してください。
継続的な問題については、DeepWikiのドキュメントページをご参照ください。

**🔗 DeepWiki**: https://deepwiki.com/shimizu8502/WikiMarkDownConverter/1-wikimarkdownconverter-overview 